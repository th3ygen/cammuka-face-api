<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Register & Recognize Face</title>

        <link rel="stylesheet" href="./style-out.css" />

        <!-- Using Tailwind CSS via CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        
        <!-- Loading libraries from CDN -->
        <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />

        <style>
            /* Custom styles that cannot be directly translated to Tailwind or need specific handling */
            body {
                font-family: "Inter", sans-serif;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            /* Spinner Animation */
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            #loader {
                display: none;
                border: 5px solid #f3f3f3;
                border-radius: 50%;
                border-top: 5px solid #3498db;
                width: 50px;
                height: 50px;
                animation: spin 1s linear infinite;
                margin: 50px auto;
            }

            /* Video and Canvas overlay */
            .video-container video,
            .video-container canvas {
                transform: scaleX(-1); /* Keep the flip for camera feed */
            }

            /* Animation for new log items */
            @keyframes fadeInDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .animate-fade-in-down {
                animation: fadeInDown 0.5s ease-out forwards;
            }

            /* Specific style for the video container aspect ratio */
            .video-aspect-ratio {
                position: relative;
                width: 100%;
                padding-top: 75%; /* 4:3 Aspect Ratio */
            }
            .video-aspect-ratio video,
            .video-aspect-ratio canvas {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            /* --- STYLES FOR ANIMATED TOGGLE BUTTONS --- */
            .toggle-button {
                background-color: #374151; /* Corresponds to bg-gray-700 */
                transition: background-color 0.3s ease;
            }

            .toggle-button.active {
                background-color: #2563eb; /* Corresponds to bg-blue-600 */
                color: white;
            }

            .toggle-button:hover:not(.active) {
                background-color: #4b5563; /* Corresponds to bg-gray-600 */
            }
        </style>
    </head>
    <body
        class="m-0 p-5 box-border w-screen h-screen flex flex-col justify-start items-center bg-gray-900 text-gray-200 overflow-hidden"
    >
        <div class="main-container w-full h-[100dvh]">
            <div
                id="status-message"
                class="fixed top-20 left-1/2 -translate-x-1/2 bg-black bg-opacity-80 text-white px-5 py-2 rounded-lg z-50 hidden backdrop-blur-sm text-base"
            >
                Loading AI Models...
            </div>

            <div class="grid grid-cols-5 gap-4 h-full">
                <div class="col-span-1 min-h-[100px]">
                    <div
                        class="ui-section bg-gray-800 p-4 rounded-xl shadow-lg h-full flex items-center gap-8 justify-center text-gray-400"
                    >
                    <img src="./assets/logo.png" alt="logo" class="h-20" />
                    <div class="flex flex-col items-center font-bold">
                            <div id="time"></div>
                            <div id="date"></div>
                        </div>
                    </div>
                </div>

                <div class="col-span-3 h-full ">
                    <div
                        id="recognition-status"
                        class="ui-section bg-gray-700 p-2 h-[200px] rounded-xl shadow-lg text-center font-bold text-5xl transition-colors duration-300 "
                    >
                        IDLE
                    </div>
                </div>

                <div
                    id="details-section"
                    class="col-span-1 row-span-2 ui-section bg-gray-800 p-8 rounded-xl shadow-2xl overflow-y-auto"
                >
                    <div id="loader"></div>
                    <div id="details-card-content">
                        <img
                            id="details-image"
                            src="https://placehold.co/400x400/2c2c2c/e0e0e0?text=No+Detection"
                            alt="Detected Person"
                            class="w-full rounded-lg mb-6 border-2 border-gray-700 object-cover aspect-square"
                        />
                        <div class="details-text">
                            <p class="my-2 text-lg p-2 rounded-md bg-gray-700">
                                <strong>Name:</strong>
                                <span id="details-name" class="text-blue-400">N/A</span>
                            </p>
                            <p class="my-2 text-lg p-2 rounded-md bg-gray-700">
                                <strong>Category:</strong>
                                <span id="details-category" class="text-blue-400">N/A</span>
                            </p>
                            <p class="my-2 text-lg p-2 rounded-md bg-gray-700">
                                <strong>No. Banduan:</strong>
                                <span id="details-banduan" class="text-blue-400">N/A</span>
                            </p>
                            <!-- ADDED FIELDS START -->
                            <p class="my-2 text-lg p-2 rounded-md bg-gray-700">
                                <strong>Admission Date:</strong>
                                <span id="details-admission-date" class="text-blue-400">N/A</span>
                            </p>
                            <p class="my-2 text-lg p-2 rounded-md bg-gray-700">
                                <strong>Release Date:</strong>
                                <span id="details-release-date" class="text-blue-400">N/A</span>
                            </p>
                            <p class="my-2 text-lg p-2 rounded-md bg-gray-700">
                                <strong>Case Number:</strong>
                                <span id="details-case-number" class="text-blue-400">N/A</span>
                            </p>
                            <!-- ADDED FIELDS END -->
                        </div>
                    </div>
                </div>

                <div class="col-span-1 flex flex-col gap-4">
                    <div
                        id="toggle-buttons-card"
                        class="relative ui-section bg-gray-800 p-4 rounded-xl shadow-2xl h-full flex flex-col justify-center"
                    >
                        <div id="button-container" class="flex flex-col gap-2">
                            <button
                                class="toggle-button text-white font-bold py-10 px-4 rounded-lg transition duration-300 text-lg"
                            >
                                BLKP
                            </button>
                            <button
                                class="toggle-button text-white font-bold py-10 px-4 rounded-lg transition duration-300 text-lg"
                            >
                                Mahkamah
                            </button>
                            <button
                                class="toggle-button text-white font-bold py-10 px-4 rounded-lg transition duration-300 text-lg"
                            >
                                Rawatan
                            </button>
                            <button
                                class="toggle-button text-white font-bold py-10 px-4 rounded-lg transition duration-300 text-lg"
                            >
                                Rotan
                            </button>
                            <button
                                class="toggle-button text-white font-bold py-10 px-4 rounded-lg transition duration-300 text-lg"
                            >
                                All
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-span-3 flex flex-col gap-8">
                    <div
                        id="recognition-section"
                        class="ui-section bg-gray-800 p-8 rounded-xl shadow-2xl h-full"
                    >
                        <div
                            class="video-container relative rounded-xl overflow-hidden bg-gray-700 h-full video-aspect-ratio"
                        >
                            <video
                                id="video"
                                autoplay
                                muted
                                playsinline
                            ></video>
                            <canvas id="canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // DOM Elements
            const recognitionStatus =
                    document.getElementById("recognition-status"),
                video = document.getElementById("video"),
                canvas = document.getElementById("canvas"),
                statusMessage = document.getElementById("status-message"), // Global status
                loader = document.getElementById("loader"),
                detailsCardContent = document.getElementById(
                    "details-card-content"
                ),
                detailsImage = document.getElementById("details-image"),
                detailsName = document.getElementById("details-name"),
                detailsCategory = document.getElementById("details-category"),
                detailsBanduan = document.getElementById("details-banduan"),
                detailsAdmissionDate = document.getElementById("details-admission-date"),
                detailsReleaseDate = document.getElementById("details-release-date"),
                detailsCaseNumber = document.getElementById("details-case-number");
                
            let recognitionLog = document.getElementById("recognition-log");
            if (!recognitionLog) {
                recognitionLog = document.createElement("div"); 
            }

            // State
            let labeledFaceDescriptors = [];
            let faceMatcher = null;
            let detectionInterval = null;
            let isVideoPlaying = false;
            let currentlyDisplayedInmate = null;
            let previousLogId = null;
            let clearDetailsTimer = null; 
            let activeCategory = 'BLKP'; // Default category

            const faceDetails = new Map();

            // --- MODIFIED: Added FRAUD status color ---
            const STATUS_COLORS = {
                IDLE: "bg-gray-700",
                DETECTED: "bg-green-700",
                UNKNOWN: "bg-yellow-500",
                'CATEGORY MISMATCH': "bg-red-500", 
            };

            function updateStatus(status, message = "") {
                recognitionStatus.textContent = status;
                recognitionStatus.className = `ui-section p-8 rounded-xl h-full shadow-lg text-center font-bold text-5xl transition-colors duration-300 flex items-center justify-center ${STATUS_COLORS[status]}`;
                // if (message) showStatus(message, 3000);
            }

            function showStatus(message, duration = 3000) {
                statusMessage.innerText = message;
                statusMessage.style.display = "block";
                if (duration)
                    setTimeout(
                        () => (statusMessage.style.display = "none"),
                        duration
                    );
            }

            function addLogEntry(inmateName, inmateId, imageUrl) {
                if (previousLogId === inmateId) {
                    return;
                }
                previousLogId = inmateId;

                const logItem = document.createElement("div");
                logItem.className =
                    "recognition-log-item flex items-center gap-4 p-3 bg-gray-700 rounded-lg shadow-md animate-fade-in-down";
                logItem.innerHTML = `
                <img src="${
                    imageUrl ||
                    `https://placehold.co/60x60/333/eee?text=${inmateName.charAt(
                        0
                    )}`
                }" alt="${inmateName}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-600">
                <div>
                    <p class="font-semibold text-lg text-white">${inmateName}</p>
                    <p class="text-sm text-gray-300">ID: ${inmateId}</p>
                    <p class="text-xs text-gray-400">${new Date().toLocaleString()}</p>
                </div>
            `;
                recognitionLog.prepend(logItem);

                if (recognitionLog.children.length > 10) {
                    recognitionLog.removeChild(recognitionLog.lastChild);
                }
            }
            
            // --- NEW FUNCTION: Checks for category mismatch ---
            function recheckCurrentDetectionForFraud() {
                if (!currentlyDisplayedInmate || currentlyDisplayedInmate === 'unknown') {
                    return;
                }

                const details = faceDetails.get(currentlyDisplayedInmate);
                const personCategory = details?.serverData?.category;

                if (!personCategory) {
                    // We don't have the data from the server yet, so we can't check.
                    return;
                }
                
                // Perform the fraud check. "All" is a wildcard and never fraud.
                const isFraud = activeCategory.toLowerCase() !== 'all' && personCategory.toLowerCase() !== activeCategory.toLowerCase();

                if (isFraud) {
                    updateStatus("CATEGORY MISMATCH", "Category Mismatch");
                } else {
                    // If it's not fraud, ensure the status is back to 'DETECTED'.
                    updateStatus("DETECTED", `Recognized: ${currentlyDisplayedInmate}`);
                }
            }


            // --- WebSocket Setup ---
            console.log("Attempting to connect to Data WebSocket at ws://recon.local:1337");
            const dataWebSocket = new WebSocket("ws://recon.local:1337");
            dataWebSocket.onopen = () => { showStatus("Data connection established.", 2000); };
            dataWebSocket.onerror = (error) => { showStatus("Data WebSocket Error.", null); };
            dataWebSocket.onclose = () => { showStatus("Data connection closed.", null); };

            console.log("Attempting to connect to Info Socket.IO at http://recon.local:5002");
            const infoSocket = io("http://recon.local:5002");
            infoSocket.on("connect", () => { showStatus("Info connection established.", 2000); });
            infoSocket.on("disconnect", () => { showStatus("Info connection lost.", null); });

            // --- MODIFIED: Added fraud check on data arrival ---
            infoSocket.on("match_found", (data) => {
                console.log("Received match_found event with data:", data);
                if (currentlyDisplayedInmate === data.inmate_number) {
                    
                    // Store server data in our map
                    const localDetails = faceDetails.get(data.inmate_number);
                    if(localDetails) {
                        localDetails.serverData = data;
                    } else {
                        faceDetails.set(data.inmate_number, { serverData: data });
                    }
                    
                    // Now that we have the category, check for fraud
                    recheckCurrentDetectionForFraud();
                    
                    // Update the details card regardless of fraud status
                    if (localDetails && localDetails.imageUrl) {
                        detailsImage.src = localDetails.imageUrl;
                    } else {
                        detailsImage.src = data.picpath || `https://placehold.co/400x400/2c2c2c/e0e0e0?text=${data.name.replace(" ", "+")}`;
                    }
                    detailsImage.onerror = () => { detailsImage.src = `https://placehold.co/400x400/2c2c2c/e0e0e0?text=Image+Not+Found`; detailsImage.onerror = null; };

                    detailsName.textContent = data.name || "N/A";
                    detailsCategory.textContent = data.category || "N/A";
                    detailsBanduan.textContent = data.inmate_number || "N/A";
                    detailsAdmissionDate.textContent = data.admission_date || "N/A";
                    detailsReleaseDate.textContent = data.release_date || "N/A";
                    detailsCaseNumber.textContent = data.case_number || "N/A";

                    loader.style.display = "none";
                    detailsCardContent.style.display = "block";
                    addLogEntry(data.name, data.inmate_number, detailsImage.src);

                } else {
                    console.log(`Ignoring stale match data for ${data.inmate_number}. Currently displaying ${currentlyDisplayedInmate}.`);
                }
            });
            
            async function loadPredefinedFaceData() {
                try {
                    const response = await fetch('face_data.json');
                    if (!response.ok) { throw new Error(`File not found: ${response.status}`); }
                    const data = await response.json();
                    labeledFaceDescriptors = data.descriptors.map(d => faceapi.LabeledFaceDescriptors.fromJSON(d));
                    if (data.details) {
                       data.details.forEach(([key, value]) => faceDetails.set(key, value));
                    }
                    console.log(`Auto-loaded ${labeledFaceDescriptors.length} people.`);
                } catch (error) {
                    console.error('Could not auto-load face data:', error);
                    updateStatus("UNKNOWN", "face_data.json not found.");
                }
            }
            
            async function loadModels() {
                const MODEL_URL = "https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights";
                try {
                    updateStatus("IDLE", "Loading AI Models...");
                    await Promise.all([
                        faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    ]);
                    updateStatus("IDLE", "Models Loaded! Loading face data...");
                    await loadPredefinedFaceData();
                    startVideoAndRecognition();
                } catch (error) {
                    console.error("Error during startup:", error);
                    updateStatus("UNKNOWN", "Error loading models or face data.");
                }
            }

            async function startVideo() {
                if (isVideoPlaying) return;
                try {
                    video.srcObject = await navigator.mediaDevices.getUserMedia({ video: {} });
                    isVideoPlaying = true;
                    video.onloadedmetadata = () => { video.play(); };
                } catch (err) {
                    console.error("Error accessing webcam:", err);
                    updateStatus("UNKNOWN", "Webcam access denied.");
                }
            }

            function startVideoAndRecognition() {
                if (labeledFaceDescriptors.length === 0) {
                    updateStatus("UNKNOWN", "No faces registered.");
                    return;
                }
                faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.47);
                updateStatus("IDLE", `Recognition active for ${labeledFaceDescriptors.length} people.`);
                startVideo();
            }

            video.addEventListener("play", () => {
                if (detectionInterval) clearInterval(detectionInterval);

                detectionInterval = setInterval(async () => {
                    if (!faceMatcher || !isVideoPlaying) return;

                    const displaySize = { width: video.clientWidth, height: video.clientHeight };
                    faceapi.matchDimensions(canvas, displaySize);
                    const detections = await faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptors();
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    const context = canvas.getContext("2d");
                    context.clearRect(0, 0, canvas.width, canvas.height);

                    let foundKnownPersonThisFrame = false;
                    if (resizedDetections.length > 0) {
                        resizedDetections.forEach((detection) => {
                            const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                            if (bestMatch.label !== "unknown") {
                                foundKnownPersonThisFrame = true;

                                if (clearDetailsTimer) {
                                    clearTimeout(clearDetailsTimer);
                                    clearDetailsTimer = null;
                                }

                                if (currentlyDisplayedInmate !== bestMatch.label) {
                                    currentlyDisplayedInmate = bestMatch.label;
                                    updateStatus("DETECTED", `Recognized: ${bestMatch.label}`);
                                    console.log(`Detected inmate: ${currentlyDisplayedInmate}. Sending request...`);
                                    loader.style.display = "block";
                                    if (dataWebSocket.readyState === WebSocket.OPEN) {
                                        dataWebSocket.send(JSON.stringify({ number: currentlyDisplayedInmate }));
                                    }
                                }
                                // Re-check for fraud on every frame in case data has arrived
                                recheckCurrentDetectionForFraud();

                            }
                            // Drawing logic for box and text
                            const box = detection.detection.box;
                            const text = bestMatch.toString();
                            new faceapi.draw.DrawBox(box).draw(canvas);
                        });
                    }

                    if (!foundKnownPersonThisFrame) {
                        if (currentlyDisplayedInmate && currentlyDisplayedInmate !== 'unknown') {
                            if (!clearDetailsTimer) {
                                clearDetailsTimer = setTimeout(() => {
                                    updateStatus("IDLE", "No faces detected.");
                                    detailsImage.src = "https://placehold.co/400x400/2c2c2c/e0e0e0?text=No+Detection";
                                    detailsName.textContent = "N/A";
                                    detailsCategory.textContent = "N/A";
                                    detailsBanduan.textContent = "N/A";
                                    detailsAdmissionDate.textContent = "N/A";
                                    detailsReleaseDate.textContent = "N/A";
                                    detailsCaseNumber.textContent = "N/A";
                                    currentlyDisplayedInmate = null;
                                    previousLogId = null;
                                    clearDetailsTimer = null;
                                }, 5000);
                            }
                        } else if (resizedDetections.length > 0 && currentlyDisplayedInmate !== 'unknown') {
                             updateStatus("UNKNOWN", "Unknown face detected!");
                             detailsImage.src = "https://placehold.co/400x400/e0e0e0/2c2c2c?text=UNKNOWN";
                             detailsName.textContent = "Unknown";
                             detailsCategory.textContent = "N/A";
                             detailsBanduan.textContent = "N/A";
                             detailsAdmissionDate.textContent = "N/A";
                             detailsReleaseDate.textContent = "N/A";
                             detailsCaseNumber.textContent = "N/A";
                             currentlyDisplayedInmate = 'unknown';
                        } else if (resizedDetections.length === 0) {
                            if(!currentlyDisplayedInmate) updateStatus("IDLE", "No faces detected.");
                        }
                    }
                }, 500);
            });

            document.addEventListener("DOMContentLoaded", () => {
                const timeEl = document.getElementById("time");
                const dateEl = document.getElementById("date");

                function updateClock() {
                    const now = new Date();
                    timeEl.textContent = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    dateEl.textContent = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
                }
                
                updateClock();
                setInterval(updateClock, 1000);

                // --- MODIFIED: Toggle Button Logic ---
                const toggleButtons = document.querySelectorAll(".toggle-button");
                let activeToggleButton = null;

                function activateButton(button) {
                    if (activeToggleButton) {
                        activeToggleButton.classList.remove("active");
                    }
                    button.classList.add("active");
                    activeToggleButton = button;
                    activeCategory = button.textContent.trim(); // Update global state
                }

                toggleButtons.forEach((button) => {
                    button.addEventListener("click", () => {
                        if (button === activeToggleButton) return;
                        activateButton(button);
                        recheckCurrentDetectionForFraud(); // Re-validate on category change

                        anime({
                            targets: button,
                            scale: [{ value: 0.95, duration: 150, easing: "easeOutQuad" }, { value: 1, duration: 250, easing: "easeOutQuad" }],
                        });
                    });
                });

                if (toggleButtons.length > 0) {
                    activateButton(toggleButtons[0]); // Set initial active button
                }
            });

            loadModels();
        </script>
    </body>
</html>
